<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>بوت دردشة متطور + قراءة نص من صورة (OCR)</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2em auto; padding: 1em; background: #f0f0f5; }
  #chatbox { border: 1px solid #ccc; background: white; padding: 1em; height: 350px; overflow-y: auto; white-space: pre-wrap; }
  .message { margin: 1em 0; }
  .user { color: blue; }
  .bot { color: green; }
  textarea { width: 100%; height: 80px; margin-top: 1em; }
  button { padding: 10px 20px; margin-top: 0.5em; }
  #imageInput { margin-top: 1em; }
</style>
</head>
<body>

<h2>بوت دردشة متطور + قراءة نص من صورة (OCR) بدون API</h2>

<div id="chatbox"></div>

<textarea id="input" placeholder="اكتب رسالتك هنا..."></textarea><br />
<button onclick="sendMessage()">أرسل</button><br />

<label for="imageInput">ارفع صورة لاستخراج النص منها:</label><br />
<input type="file" id="imageInput" accept="image/*" />

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
const chatbox = document.getElementById('chatbox');
const input = document.getElementById('input');
const imageInput = document.getElementById('imageInput');

// تخزين النص المستخرج من الصور
let lastExtractedText = "";

// قاعدة ردود بوت ذكيّة مع كلمات مفتاحية مرنة
const responses = [
  { keywords: ["مرحبا", "أهلا", "السلام"], reply: "مرحباً بك! كيف يمكنني مساعدتك اليوم؟" },
  { keywords: ["كيف حالك", "كيف أنت", "الحال"], reply: "أنا بخير، شكراً لسؤالك! كيف يمكنني خدمتك؟" },
  { keywords: ["ما اسمك", "من أنت", "من تكون"], reply: "أنا بوت دردشة متطور أعمل بدون API وأستطيع قراءة نصوص من الصور." },
  { keywords: ["وداعا", "مع السلامة", "إلى اللقاء"], reply: "مع السلامة! أتمنى لك يوماً رائعاً." },
  { keywords: ["شكراً", "شكرا", "متشكر"], reply: "على الرحب والسعة! أي شيء تحتاجه أنا هنا." },
  { keywords: ["كيف تعمل", "كيف تشتغل", "كيف تشتغل؟"], reply: "أنا أستخدم قاعدة كلمات مفتاحية للرد، وأقرأ نصوص من الصور باستخدام تقنية OCR." },
  { keywords: ["ماذا تفعل", "ما عملك", "وظيفتك"], reply: "أساعدك بالدردشة، وأستطيع قراءة نص من الصور التي ترفعها!" },
  { keywords: ["النص المستخرج", "النص الذي استخرجته", "ما هو النص"], reply: () => {
    return lastExtractedText 
      ? `النص الأخير الذي استخرجته من الصورة هو:\n${lastExtractedText}` 
      : "لم يتم رفع أي صورة بعد لاستخراج النص.";
  }},
];

// دالة إيجاد الرد المناسب، تدعم الدوال للردود المتقدمة
function findReply(text) {
  const lowerText = text.toLowerCase();

  // تحقق أولاً هل المستخدم يريد النص من الصور؟
  for (const item of responses) {
    for (const kw of item.keywords) {
      if (lowerText.includes(kw.toLowerCase())) {
        if (typeof item.reply === "function") {
          return item.reply();
        } else {
          return item.reply;
        }
      }
    }
  }

  // بحث عن أفضل تطابق بناءً على عدد الكلمات المفتاحية
  let bestMatch = null;
  let maxMatches = 0;

  for (const item of responses) {
    let matches = 0;
    for (const kw of item.keywords) {
      if (lowerText.includes(kw.toLowerCase())) {
        matches++;
      }
    }
    if (matches > maxMatches) {
      maxMatches = matches;
      bestMatch = item.reply;
    }
  }

  if (maxMatches === 0) {
    const defaultReplies = [
      "عذراً، لم أفهم سؤالك جيداً. هل يمكنك إعادة الصياغة؟",
      "هل يمكنك التوضيح أكثر؟",
      "أنا أحاول مساعدتك، لكن لم أفهم تماماً.",
      "هل يمكنك أن تسأل بطريقة أخرى؟"
    ];
    return defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
  }

  if (typeof bestMatch === "function") {
    return bestMatch();
  }
  return bestMatch;
}

function appendMessage(role, text) {
  const div = document.createElement('div');
  div.classList.add('message', role);
  div.textContent = (role === 'user' ? "أنت: " : "البوت: ") + text;
  chatbox.appendChild(div);
  chatbox.scrollTop = chatbox.scrollHeight;
}

function sendMessage() {
  const userMessage = input.value.trim();
  if (!userMessage) return;
  appendMessage('user', userMessage);
  input.value = '';

  setTimeout(() => {
    const botReply = findReply(userMessage);
    appendMessage('bot', botReply);
  }, 700);
}

// معالجة رفع الصور واستخراج النص منها
imageInput.addEventListener('change', () => {
  const file = imageInput.files[0];
  if (!file) return;

  appendMessage('user', `[صورة مرفوعة: ${file.name}]`);
  appendMessage('bot', 'جارٍ استخراج النص من الصورة...');

  Tesseract.recognize(
    file,
    'ara',
    { logger: m => console.log(m) }
  ).then(({ data: { text } }) => {
    removeLastBotMessage();

    if (text.trim()) {
      lastExtractedText = text.trim();
      appendMessage('bot', "تم استخراج النص من الصورة بنجاح:\n" + lastExtractedText);
    } else {
      appendMessage('bot', "لم أتمكن من استخراج نص من الصورة.");
    }
  }).catch(err => {
    removeLastBotMessage();
    appendMessage('bot', "حدث خطأ أثناء استخراج النص: " + err.message);
  });

  imageInput.value = "";
});

function removeLastBotMessage() {
  const messages = chatbox.querySelectorAll('.bot');
  if (messages.length > 0) {
    chatbox.removeChild(messages[messages.length - 1]);
  }
}
</script>

</body>
</html>
